---
title: "Education paths with the greatest tail risk"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
resource_files:
- data/median_salary.xlsx
- data/skills_original.xlsx
- out/cip_noc_all_ages_processed.csv
- out/top_paths_to_and_from.xlsx
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shinyWidgets)
library(tidyverse)
library(here)
library(readxl)
library(plotly)
library(conflicted)
cip_noc_all <- read_csv(here("out","cip_noc_all_ages_processed.csv"))|>
  rename(NOCtemp=NOC)|>
  mutate(NOC=str_sub(NOCtemp, 1,5),
         Description=str_sub(NOCtemp, 7), .before=everything())|>
  select(-NOCtemp)

edu_prop_all_noc <- cip_noc_all|>
  group_by(Education)|>
  summarise(value=sum(value))|>
  ungroup()|>
  mutate(all_share=value/sum(value))

median_salaries <- read_excel(here("data","median_salary.xlsx"))|>
  select(NOC, median_salary=contains("calculated"))

paths <- read_excel(here("out","top_paths_to_and_from.xlsx"), sheet = "Paths to Occupation all ages")|>
  select(`For workers in this occupation`, `# of educations with share > 1%`)|>
  mutate(NOC=str_sub(`For workers in this occupation`,1,5),
         Description=str_sub(`For workers in this occupation`, 7), .before=everything()
         )|>
  select(-`For workers in this occupation`)

skills <- read_excel(here("data", "skills_original.xlsx"))|>
  mutate(NOC=str_pad(noc2021, 5, "left", "0"), .before=everything())|>
  select(-noc2021)|>
  group_by(NOC)|>
  summarize(average_skill=round(mean(value_mean),2))
```

Introduction
=====================================  

One important use of the British Columbia Labour Market Outlook is to encourage prospective students to choose fields of study that have a clear/narrow path to high opportunity occupations. Consider optometry, where 91% of people with a degree in optometry work as optometrists. For such narrow paths the LMO provides *positive* guidance regarding field of study.

However there are many occupations that do not have such a clear linkage with education, which makes education a risky investment. Most people are risk averse^[at least for large gambles, like education], and are willing to sacrifice some expected return in exchange for greater certainty in outcomes.  Here we focus on lower tail (worst case scenario) risk: i.e. what educational choices make it more likely you will end up in an occupation that 

1) does not pay well, 
2) does not require much skill, and 
3) has many educational paths leading to it.

All three of these attributes suggest (in different ways) a low or negative rate of return on education. 

1) If your occupation does not pay well, it makes it less likely the difference (from the counter factual) in discounted expected lifetime earnings is positive.
2) If your occupation does not require much skill, it makes it less likely the skills you acquired during your education are of value to your employer.
3) If there are many educational paths leading to your occupation, it makes it less likely the skills you acquired during your education are of value to your employer. (i.e. the employer is not picky about the educational background of its employees) 

The LMO *encourages* prospective students to follow educational paths that lead clearly/narrowly to high opportunity occupations.  In contrast, here we are *warning* prospective students about fields of study that are over-represented in low pay, low skill occupations, which is critically important information to a risk averse individual if they are contemplating a field of study with many paths to the labour market.  

Note that these education investment decisions are also important from a social perspective: as a society we are better off if we can curtail low or negative return education investments.


Inputs {.sidebar}
=====================================

We begin by indentifying undesirable occupations that:

1) offers a low median salary 
2) requires low skills 
3) have many educational pathways leading to the occupation

But how low is low?  How many is many? You choose.

```{r}
#inputs---------------------------
sliderInput("salary", "the lowest % of salaries", 10, 100, 10, step = 1)
sliderInput("skill", "the lowest % of skills", 10, 100, 10, step = 1)
sliderInput("paths", "the broadest % of paths", 10, 100, 100, step = 1)
#reactive elements----------------------
low_median_salary <- reactive({
  median_salaries|>
    slice_min(median_salary, prop = (input$salary/100))
})
low_skills <- reactive({
  skills|>
    slice_min(average_skill, prop = (input$skill/100))
})
broad_paths <- reactive({
  paths|>
    slice_max(`# of educations with share > 1%`, prop = (input$paths/100))
})
shit_occ <- reactive({
  inner_join(low_median_salary(), broad_paths())|>
  inner_join(low_skills())|>
    distinct()
})
edu_prop_shit <- reactive({
  cip_noc_all|>
  semi_join(shit_occ())|>
  group_by(Education)|>
  summarise(value=sum(value))|>
  ungroup()|>
  mutate(shit_share=value/sum(value))
})
edu_prop <- reactive({
  full_join(edu_prop_all_noc, edu_prop_shit(), by="Education")|>
  separate(Education, into = c("CIP", "highest"), sep = ": ")
})
```

*  On the "App" page you see a plot each field of study's proportion of all jobs vs. the field of study's proportion of undesirable jobs.  

*  Jobs that are significantly above the diagonal white line are over-represented in undesirable jobs, and vice versa. 

The app
========================================
    
### 

```{r}
renderPlotly({
plt <- ggplot(edu_prop(), aes(all_share, 
                            shit_share,
                            text=CIP))+
  geom_abline(slope = 1, intercept = 0, colour="white", lwd=2)+
  geom_point(alpha=.25)+
  scale_x_continuous(trans="log10", labels = scales::percent)+
  scale_y_continuous(trans="log10", labels = scales::percent)+
  facet_wrap(~highest)+
  labs(x="Field of study's share of all occupations",
       y="Field of study's share of undesirable occupations",
       title="Fields of study above diagonal over-represented in undesirable occupation, below diagonal under-represented")+
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)))

plotly::ggplotly(plt, tooltip="text")
})
```

The undesirable occupations
=====================================  

```{r}
DT::renderDT({
  DT::datatable(shit_occ(), options = list(pageLength = -1))%>% 
                  DT::formatCurrency(c('median_salary'))
})
```





